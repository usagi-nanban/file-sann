<!-- upload.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ファイルアップロード</title>
  <style>
    #progressBar {
      width: 100%;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    #progressBarInner {
      width: 0%;
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h1>ファイルをアップロード</h1>
  <input type="file" id="fileInput"><br><br>
  <input type="password" id="passwordInput" placeholder="パスワード（任意）"><br><br>
  <button id="uploadBtn">アップロード</button>

  <div id="progressBar"><div id="progressBarInner"></div></div>
  <p id="result"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD3S65gqdJSGJoeKTY7en6IPiEhu-7SmHs",
      authDomain: "file-app-712ea.firebaseapp.com",
      databaseURL: "https://file-app-712ea-default-rtdb.firebaseio.com",
      projectId: "file-app-712ea",
      storageBucket: "file-app-712ea.appspot.com",
      messagingSenderId: "969390416407",
      appId: "1:969390416407:web:1721ff472e09ee8d053252",
      measurementId: "G-KMEVC3Q5RE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const updateProgress = (percent) => {
      document.getElementById("progressBarInner").style.width = percent + "%";
    };

    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById("fileInput").files[0];
      const password = document.getElementById("passwordInput").value;
      const result = document.getElementById("result");

      if (!file) {
        result.textContent = "ファイルを選択してください。";
        return;
      }

      updateProgress(10);

      const arrayBuffer = await file.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      updateProgress(30);

      const binary = [...bytes].map(b => b.toString(2).padStart(8, '0')).join('');
      updateProgress(50);

      const base64like = btoa(binary.match(/.{1,6}/g).map(bin => String.fromCharCode(parseInt(bin, 2))).join(''));
      updateProgress(70);

      const fileId = Math.random().toString(36).substring(2, 10);
      await set(ref(db, "files/" + fileId), {
        filename: file.name,
        mimetype: file.type,
        data: base64like,
        password: password
      });

      updateProgress(100);
      result.innerHTML = `✅ アップロード完了！<br>ファイルID: <code>${fileId}</code>`;
    };
  </script>
</body>
</html>
